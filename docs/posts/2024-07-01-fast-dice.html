<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Fast Dice &mdash; aji's Blog</title>
        <link rel="icon" type="image/x-icon" href="../images/icon.ico" />
        <link rel="icon" type="image/png" href="../images/icon.png" />
        <link rel="stylesheet" href="../css/default.css" />
        <link rel="alternate" type="application/atom+xml" href="feed.xml" />

        
          <meta name="twitter:card" content="summary_large_image" />
          <meta name="twitter:site" content="@ajixander" />
          <meta name="og:type" content="article" />
          <meta name="og:site_name" content="aji's Blog" />
          <meta property="og:title" content="Fast Dice" />
        
        
          <meta name="description" content="Don't take any chances without knowing the odds" />
          <meta name="twitter:description" content="Don't take any chances without knowing the odds" />
          <meta property="og:description" content="Don't take any chances without knowing the odds" />
        
        
          <meta name="twitter:image" content="https://aji.github.io/blog/images/2024-07-01-fast-dice.jpg" />
          <meta name="og:image" content="https://aji.github.io/blog/images/2024-07-01-fast-dice.jpg" />
        

        
        <script type="application/ld+json">
          {
            "@context": "https://schema.org",
            "@type": "Article",
            "headline": "Fast Dice",
            "author": {
              "@type": "Person",
              "name": "aji"
            },
            "image": "https://aji.github.io/blog/images/2024-07-01-fast-dice.jpg",
            "datePublished": "2024-07-01",
            "description": "Don't take any chances without knowing the odds",
            "isAccessibleForFree": "True"
          }
        </script>
        
    </head>
    <body>
        <header><a href="../">aji's Blog</a>
        </header>

        <main role="main">
            <article>
    <section class="header">
        
            <img class="banner" src="../images/2024-07-01-fast-dice.jpg" width="1400" height="700" />
        
        <div class="published">2024-07-01</div>
        <h1>Fast Dice</h1>
        
            <p>Don't take any chances without knowing the odds</p>
        
    </section>
    <section class="body">
        <p>I got nerd sniped by a fun JavaScript performance puzzle recently, having to do
with efficiently calculating the probability of a dice-based Bernoulli trial, for
the purpose of a game I’m working on. It goes like this:</p>
<ul>
<li><p>The player works to collect sets of up to 4 dice, which can be d4s, d6s, or d10s.</p></li>
<li><p>The player then chooses up to 10 sets of dice from their collection and rolls them.</p></li>
<li><p>If at least 3 of the sets rolled have a total of 10 or more, the player
advances to the next round. All rolled sets are removed from the player’s
collection, regardless of whether they advance or not.</p></li>
</ul>
<p>It’s helpful to be able to calculate the exact probabilities involved when
balancing the game, in addition to playtesting normally. Furthermore, having the
exact probabilities allows game design elements to reflect the chance of success
(e.g. showing things in a different color) in a way that gives the player <em>some</em>
useful information while still leaving a bit of uncertainty. However, with the
way this process is designed, calculating the probabilities presents a few
challenges:</p>
<ul>
<li><p>Sets can have any combination of dice, e.g. 4d6, 2d4+d10, 3d6+d10, etc.</p></li>
<li><p>Sets of dice are tested based on their sum.</p></li>
<li><p>The player advances if at least 3 sets score 10 or more, but have the option
to play more than 3 if they think it would help their chances enough to be worth
it.</p></li>
</ul>
<p>So, to get this problem out of the way and avoid coming up with any tricky
equations, I went with the most general solution I know: convolutions of
probability distributions. (This formulation is equivalent to multiplying
probability generating functions, since we are dealing with discrete random
variables.)</p>
<h2 id="background-too-convoluted">Background: Too convoluted?</h2>
<p>The calculation works in two passes:</p>
<ol type="1">
<li><p>For each set of dice, generate a CDF of the dice total by reducing the PMFs
of the dice with convolutions and doing a cumulative sum. The CDF at 9
represents the Bernoulli parameter for whether the set fails to reach a score
of 10.</p></li>
<li><p>For each Bernoulli parameter <em>p</em> calculated in the previous step, generate a
PMF [<em>p</em>, 1-<em>p</em>] to represent a random variable that has a value of 1 if
the test succeeds and 0 otherwise. Reduce these by convolution and do a
cumulative sum to get the CDF for the sum of these scores. The CDF at 2
represents the Bernoulli parameter for whether fewer than 3 sets succeeded.</p></li>
</ol>
<p>If you’re not familiar with convolution, <a href="https://www.youtube.com/watch?v=KuXjwB4LzSA">the 3blue1brown video</a> about it
is an excellent introduction. However, if you’re in a hurry, you can think of it
as a multiplication of two polynomials, where the <em>i</em>-th element of each input
is the coefficient of <em>x</em><sup><em>i</em></sup>. The fact that the probability
distribution of a sum of random variables is a convolution of their individual
distributions is extremely useful for numerically calculating probabilities
where simpler analytic solutions are out of reach, and is the foundation of the
approach outlined above.</p>
<h2 id="attempt-1-just-write-the-code">Attempt 1: Just write the code</h2>
<p>These days JavaScript VMs are very fast, so I generally try not to overthink
things unless there is a clear need for it. Naturally I wrote some code that
looked like this:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">range</span>(n) {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> [<span class="op">...</span><span class="bu">Array</span>(n)<span class="op">.</span><span class="fu">keys</span>()]<span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">sum</span>(a) {</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> a<span class="op">.</span><span class="fu">reduce</span>((x<span class="op">,</span> y) <span class="kw">=&gt;</span> x <span class="op">+</span> y<span class="op">,</span> <span class="dv">0</span>)<span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">convolve</span>(a<span class="op">,</span> b) {</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">range</span>(a<span class="op">.</span><span class="at">length</span> <span class="op">+</span> b<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">map</span>((i) <span class="kw">=&gt;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sum</span>(<span class="fu">range</span>(b<span class="op">.</span><span class="at">length</span>)<span class="op">.</span><span class="fu">map</span>((j) <span class="kw">=&gt;</span> (a[i <span class="op">-</span> j] <span class="op">??</span> <span class="dv">0</span>) <span class="op">*</span> b[j]))</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  )<span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">cumsum</span>(a) {</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> sum <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> a<span class="op">.</span><span class="fu">map</span>((x) <span class="kw">=&gt;</span> (sum <span class="op">+=</span> x))<span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">dicepmf</span>(n) {</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="fu">range</span>(n <span class="op">+</span> <span class="dv">1</span>)<span class="op">.</span><span class="fu">map</span>((i) <span class="kw">=&gt;</span> (<span class="dv">1</span> <span class="op">&lt;=</span> i <span class="op">&amp;&amp;</span> i <span class="op">&lt;=</span> n <span class="op">?</span> <span class="dv">1</span> <span class="op">/</span> n <span class="op">:</span> <span class="dv">0</span>))<span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pSetFail</span>(ds) {</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cdf <span class="op">=</span> <span class="fu">cumsum</span>(ds<span class="op">.</span><span class="fu">map</span>((n) <span class="kw">=&gt;</span> <span class="fu">dicepmf</span>(n))<span class="op">.</span><span class="fu">reduce</span>(convolve<span class="op">,</span> [<span class="dv">1</span>]))<span class="op">;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> cdf[<span class="dv">9</span>] <span class="op">??</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pSetsFail</span>(sets) {</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> pdf <span class="op">=</span> sets</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>(pSetFail)</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">map</span>((p) <span class="kw">=&gt;</span> [p<span class="op">,</span> <span class="dv">1</span> <span class="op">-</span> p])</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">reduce</span>(convolve<span class="op">,</span> [<span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cdf <span class="op">=</span> <span class="fu">cumsum</span>(pdf)<span class="op">;</span></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> cdf[<span class="dv">2</span>] <span class="op">??</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> sets <span class="op">=</span> [</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">4</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">6</span>]<span class="op">,</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">4</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">6</span>]<span class="op">,</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>  [<span class="dv">4</span><span class="op">,</span> <span class="dv">6</span><span class="op">,</span> <span class="dv">6</span>]<span class="op">,</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>]<span class="op">;</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>(<span class="dv">1</span> <span class="op">-</span> <span class="fu">pSetsFail</span>(sets))<span class="op">;</span></span></code></pre></div>
<p>If we run the above, we get <code>0.125</code>, which is what we would expect, since the
odds of d4+2d6 totaling 10 or more is exactly 50%. In other words, we’re
flipping a coin 3 times and trying to get HHH.</p>
<p>So this solution works and has the benefit of being concise and readable, but
how fast is it? Naive convolution is O(<em>n</em><sup>2</sup>), so let’s time its worst
case in our context, 10 attempts of 4d10:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> worstcase <span class="op">=</span> <span class="fu">range</span>(<span class="dv">10</span>)<span class="op">.</span><span class="fu">map</span>(() <span class="kw">=&gt;</span> [<span class="dv">10</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="dv">10</span>])<span class="op">;</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> start <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="dv">1000</span><span class="op">;</span> i<span class="op">++</span>) <span class="fu">pSetsFail</span>(worstcase)<span class="op">;</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="kw">const</span> end <span class="op">=</span> <span class="bu">performance</span><span class="op">.</span><span class="fu">now</span>()<span class="op">;</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="bu">console</span><span class="op">.</span><span class="fu">log</span>((start <span class="op">-</span> end) <span class="op">/</span> <span class="dv">1000</span>)<span class="op">;</span></span></code></pre></div>
<p>This comes out to about 1.4ms on my machine in Node.js, which is definitely
usable if you only need it occasionally. Okay, problem solved, let’s move onto
the next thing, we’ve got a game to build.</p>
<p>…But it does seem a bit slow, doesn’t it? We’re only dealing with 40 dice
here, and only up to d10. What if we want to offer d20s or d100s? We’re just
doing multiplications and additions, so surely we can do better, right? We
should be able to call this 100 times a frame if we want!</p>
<h2 id="attempt-2-loops">Attempt 2: Loops</h2>
<p>The <code>convolve</code> function we wrote is definitely a big part of the problem, and
you don’t need a profiler to figure that out. It’s two loops, where the inner
loop is generating an array just to calculate its sum. We’re also deliberately
looking up keys that don’t exist and using the nullish coalescing operator to
convert them to 0s, instead of explicitly checking the index. Furthermore,
we’re calculating up to 41 elements of each PMF when we only need the first 10.
We can omit those without changing the result. There’s a lot of room for some
cheap improvements and we owe it to ourselves to at least try, don’t we?</p>
<p>In particular, we suspect the following things might help:</p>
<ol type="1">
<li><p>Replace most calls to <code>range()</code>, <code>map()</code>, and <code>reduce()</code> with explicit loops and mutation.</p></li>
<li><p>Replace the nullish coalescing operator with an explicit bounds check.</p></li>
<li><p>Truncate the PMFs.</p></li>
</ol>
<p>When we make the above changes, the code looks like this:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">convolve</span>(a<span class="op">,</span> b<span class="op">,</span> limit) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> n <span class="op">=</span> <span class="bu">Math</span><span class="op">.</span><span class="fu">min</span>(limit<span class="op">,</span> a<span class="op">.</span><span class="at">length</span> <span class="op">+</span> b<span class="op">.</span><span class="at">length</span> <span class="op">-</span> <span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> out <span class="op">=</span> []<span class="op">;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> n<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    out[i] <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (<span class="kw">let</span> j <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> j <span class="op">&lt;</span> b<span class="op">.</span><span class="at">length</span><span class="op">;</span> j<span class="op">++</span>) {</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>      <span class="kw">const</span> k <span class="op">=</span> i <span class="op">-</span> j<span class="op">;</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (<span class="dv">0</span> <span class="op">&lt;=</span> k <span class="op">&amp;&amp;</span> k <span class="op">&lt;</span> a<span class="op">.</span><span class="at">length</span>) {</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>        out[i] <span class="op">+=</span> a[k] <span class="op">*</span> b[j]<span class="op">;</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">cumsum</span>(a) {</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> a<span class="op">.</span><span class="at">length</span><span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    a[i] <span class="op">+=</span> a[i <span class="op">-</span> <span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> a<span class="op">;</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">dicepmf</span>(n) {</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> out <span class="op">=</span> [<span class="dv">0</span>]<span class="op">;</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">let</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;=</span> n<span class="op">;</span> i<span class="op">++</span>) {</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    out[i] <span class="op">=</span> <span class="dv">1</span> <span class="op">/</span> n<span class="op">;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> out<span class="op">;</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pSetFail</span>(ds) {</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> pdf <span class="op">=</span> [<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> n <span class="kw">of</span> ds) {</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    pdf <span class="op">=</span> <span class="fu">convolve</span>(pdf<span class="op">,</span> <span class="fu">dicepmf</span>(n)<span class="op">,</span> <span class="dv">10</span>)<span class="op">;</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cdf <span class="op">=</span> <span class="fu">cumsum</span>(pdf)<span class="op">;</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> cdf<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">10</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> cdf[<span class="dv">9</span>]<span class="op">;</span></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pSetsFail</span>(sets) {</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> pdf <span class="op">=</span> [<span class="dv">1</span>]<span class="op">;</span></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (<span class="kw">const</span> ds <span class="kw">of</span> sets) {</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">const</span> p <span class="op">=</span> <span class="fu">pSetFail</span>(ds)<span class="op">;</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    pdf <span class="op">=</span> <span class="fu">convolve</span>(pdf<span class="op">,</span> [p<span class="op">,</span> <span class="dv">1</span> <span class="op">-</span> p]<span class="op">,</span> <span class="dv">3</span>)<span class="op">;</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> cdf <span class="op">=</span> <span class="fu">cumsum</span>(pdf)<span class="op">;</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> cdf<span class="op">.</span><span class="at">length</span> <span class="op">&lt;</span> <span class="dv">3</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> cdf[<span class="dv">2</span>]<span class="op">;</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>We’ve sacrificed a bit of conciseness perhaps but this is still quite readable.
After quickly double-checking that our first example still prints 0.125, we time
it and find that each calculation of the worst case input only takes around 15
<em>microseconds</em>. That’s a 90x improvement!</p>
<p>Of course, we should probably identify how much of an impact each of the above
changes had, so here’s rough timing figures for each one individually:</p>
<ul>
<li><p>Loops and mutation: 340us, 4.0x improvement</p></li>
<li><p>Bounds checks: 1.0ms, 1.3x improvement</p></li>
<li><p>PMF truncation: 670us, 2.0x improvement</p></li>
</ul>
<p>Loops definitely seem to have the biggest impact by themselves… but where is
the 90x improvement coming from when taken together? Microbenching a language
like JavaScript in the particular way I’m doing isn’t an exact science but there
is definitely something fishy going on. Let’s try the other direction and remove
each optimization from the fastest solution to see which one results in the
biggest slowdown:</p>
<ul>
<li><p>No loops and mutation: 410us, 28x slowdown</p></li>
<li><p>No bounds checks: 290us, 20x slowdown</p></li>
<li><p>No PMF truncation: 39us, 2.6x slowdown</p></li>
</ul>
<p>Bizarre! Loops once again seem to responsible for the biggest improvement, but
the bounds checks are an impressive factor as well. I double checked the code to
make sure I didn’t get something wrong here, but using explicit bounds checks
does seem to be responsible for a noticeable improvement. I don’t know enough
about V8 to know why this would be the case, but it’s an interesting thing to
keep in mind when trying to write JIT-friendly code I suppose. Maybe I’ll do a
deep dive someday to figure out why this happens.</p>
<p>But okay, 15 microseconds is pretty dang fast, and that’s a worst case! If we
use the 3 sets of d4+2d6 input we’ve been using for validation, we get speeds
closer to 2.5 microseconds. So we’re done, right?</p>
<p>Right??</p>
<h2 id="attempt-3-insanity">Attempt 3: Insanity</h2>
<p>Our calculation has a very predictable shape: ten times do 10-element
convolutions of four sequences and sum their entries, then do 3-element
convolutions of ten sequences and sum those. What if we just… hard-coded this?
No loops, minimal branches. How fast would it be?</p>
<p>I won’t bore you with the details and will just show you the code I came up
with. I’m not going to <em>use</em> this code, of course. It just felt like a fun
puzzle. Here’s the function that calculates the same result as <code>pSetFail()</code>
above, with slightly different parameters:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pSetFail</span>(d0<span class="op">,</span> d1<span class="op">,</span> d2<span class="op">,</span> d3) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> w0<span class="op">,</span> w1<span class="op">,</span> w2<span class="op">,</span> w3<span class="op">,</span> w4<span class="op">,</span> w5<span class="op">,</span> w6<span class="op">,</span> w7<span class="op">,</span> w8<span class="op">,</span> w9<span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> x0<span class="op">,</span> x1<span class="op">,</span> x2<span class="op">,</span> x3<span class="op">,</span> x4<span class="op">,</span> x5<span class="op">,</span> x6<span class="op">,</span> x7<span class="op">,</span> x8<span class="op">,</span> x9<span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> y0<span class="op">,</span> y1<span class="op">,</span> y2<span class="op">,</span> y3<span class="op">,</span> y4<span class="op">,</span> y5<span class="op">,</span> y6<span class="op">,</span> y7<span class="op">,</span> y8<span class="op">,</span> y9<span class="op">;</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> z0<span class="op">,</span> z1<span class="op">,</span> z2<span class="op">,</span> z3<span class="op">,</span> z4<span class="op">,</span> z5<span class="op">,</span> z6<span class="op">,</span> z7<span class="op">,</span> z8<span class="op">,</span> z9<span class="op">;</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">let</span> m<span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>  w0 <span class="op">=</span> d0 <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  w1 <span class="op">=</span> d0  <span class="op">&gt;=</span> <span class="dv">1</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>  w2 <span class="op">=</span> d0  <span class="op">&gt;=</span> <span class="dv">2</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  w3 <span class="op">=</span> d0  <span class="op">&gt;=</span> <span class="dv">3</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  w4 <span class="op">=</span> d0  <span class="op">&gt;=</span> <span class="dv">4</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>  w5 <span class="op">=</span> d0  <span class="op">&gt;=</span> <span class="dv">5</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  w6 <span class="op">=</span> d0  <span class="op">&gt;=</span> <span class="dv">6</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  w7 <span class="op">=</span> d0  <span class="op">&gt;=</span> <span class="dv">7</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>  w8 <span class="op">=</span> d0  <span class="op">&gt;=</span> <span class="dv">8</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  w9 <span class="op">=</span> d0  <span class="op">&gt;=</span> <span class="dv">9</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>  m <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  m <span class="op">*=</span> d0 <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> d0<span class="op">;</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>  m <span class="op">*=</span> d1 <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> d1<span class="op">;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>  m <span class="op">*=</span> d2 <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> d2<span class="op">;</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  m <span class="op">*=</span> d3 <span class="op">===</span> <span class="dv">0</span> <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> d3<span class="op">;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (d1) {</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>      x0<span class="op">=</span>w0<span class="op">;</span>       x1<span class="op">=</span>w1<span class="op">;</span>       x2<span class="op">=</span>w2<span class="op">;</span>       x3<span class="op">=</span>w3<span class="op">;</span>       x4<span class="op">=</span>w4<span class="op">;</span></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>      x5<span class="op">=</span>w5<span class="op">;</span>       x6<span class="op">=</span>w6<span class="op">;</span>       x7<span class="op">=</span>w7<span class="op">;</span>       x8<span class="op">=</span>w8<span class="op">;</span>       x9<span class="op">=</span>w9<span class="op">;</span>       <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">4</span><span class="op">:</span></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>      x0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>        x1<span class="op">=</span>w0<span class="op">+</span>x0<span class="op">;</span>    x2<span class="op">=</span>w1<span class="op">+</span>x1<span class="op">;</span>    x3<span class="op">=</span>w2<span class="op">+</span>x2<span class="op">;</span>    x4<span class="op">=</span>w3<span class="op">+</span>x3<span class="op">;</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>      x5<span class="op">=</span>w4<span class="op">+</span>x4<span class="op">-</span>w0<span class="op">;</span> x6<span class="op">=</span>w5<span class="op">+</span>x5<span class="op">-</span>w1<span class="op">;</span> x7<span class="op">=</span>w6<span class="op">+</span>x6<span class="op">-</span>w2<span class="op">;</span> x8<span class="op">=</span>w7<span class="op">+</span>x7<span class="op">-</span>w3<span class="op">;</span> x9<span class="op">=</span>w8<span class="op">+</span>x8<span class="op">-</span>w4<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">6</span><span class="op">:</span></span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>      x0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>        x1<span class="op">=</span>w0<span class="op">+</span>x0<span class="op">;</span>    x2<span class="op">=</span>w1<span class="op">+</span>x1<span class="op">;</span>    x3<span class="op">=</span>w2<span class="op">+</span>x2<span class="op">;</span>    x4<span class="op">=</span>w3<span class="op">+</span>x3<span class="op">;</span></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>      x5<span class="op">=</span>w4<span class="op">+</span>x4<span class="op">;</span>    x6<span class="op">=</span>w5<span class="op">+</span>x5<span class="op">;</span>    x7<span class="op">=</span>w6<span class="op">+</span>x6<span class="op">-</span>w0<span class="op">;</span> x8<span class="op">=</span>w7<span class="op">+</span>x7<span class="op">-</span>w1<span class="op">;</span> x9<span class="op">=</span>w8<span class="op">+</span>x8<span class="op">-</span>w2<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">10</span><span class="op">:</span></span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a>      x0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>        x1<span class="op">=</span>w0<span class="op">+</span>x0<span class="op">;</span>    x2<span class="op">=</span>w1<span class="op">+</span>x1<span class="op">;</span>    x3<span class="op">=</span>w2<span class="op">+</span>x2<span class="op">;</span>    x4<span class="op">=</span>w3<span class="op">+</span>x3<span class="op">;</span></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>      x5<span class="op">=</span>w4<span class="op">+</span>x4<span class="op">;</span>    x6<span class="op">=</span>w5<span class="op">+</span>x5<span class="op">;</span>    x7<span class="op">=</span>w6<span class="op">+</span>x6<span class="op">;</span>    x8<span class="op">=</span>w7<span class="op">+</span>x7<span class="op">;</span>    x9<span class="op">=</span>w8<span class="op">+</span>x8<span class="op">;</span>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (d2) {</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>      y0<span class="op">=</span>x0<span class="op">;</span>       y1<span class="op">=</span>x1<span class="op">;</span>       y2<span class="op">=</span>x2<span class="op">;</span>       y3<span class="op">=</span>x3<span class="op">;</span>       y4<span class="op">=</span>x4<span class="op">;</span></span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a>      y5<span class="op">=</span>x5<span class="op">;</span>       y6<span class="op">=</span>x6<span class="op">;</span>       y7<span class="op">=</span>x7<span class="op">;</span>       y8<span class="op">=</span>x8<span class="op">;</span>       y9<span class="op">=</span>x9<span class="op">;</span>       <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">4</span><span class="op">:</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>      y0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>        y1<span class="op">=</span>x0<span class="op">+</span>y0<span class="op">;</span>    y2<span class="op">=</span>x1<span class="op">+</span>y1<span class="op">;</span>    y3<span class="op">=</span>x2<span class="op">+</span>y2<span class="op">;</span>    y4<span class="op">=</span>x3<span class="op">+</span>y3<span class="op">;</span></span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>      y5<span class="op">=</span>x4<span class="op">+</span>y4<span class="op">-</span>x0<span class="op">;</span> y6<span class="op">=</span>x5<span class="op">+</span>y5<span class="op">-</span>x1<span class="op">;</span> y7<span class="op">=</span>x6<span class="op">+</span>y6<span class="op">-</span>x2<span class="op">;</span> y8<span class="op">=</span>x7<span class="op">+</span>y7<span class="op">-</span>x3<span class="op">;</span> y9<span class="op">=</span>x8<span class="op">+</span>y8<span class="op">-</span>x4<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">6</span><span class="op">:</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>      y0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>        y1<span class="op">=</span>x0<span class="op">+</span>y0<span class="op">;</span>    y2<span class="op">=</span>x1<span class="op">+</span>y1<span class="op">;</span>    y3<span class="op">=</span>x2<span class="op">+</span>y2<span class="op">;</span>    y4<span class="op">=</span>x3<span class="op">+</span>y3<span class="op">;</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>      y5<span class="op">=</span>x4<span class="op">+</span>y4<span class="op">;</span>    y6<span class="op">=</span>x5<span class="op">+</span>y5<span class="op">;</span>    y7<span class="op">=</span>x6<span class="op">+</span>y6<span class="op">-</span>x0<span class="op">;</span> y8<span class="op">=</span>x7<span class="op">+</span>y7<span class="op">-</span>x1<span class="op">;</span> y9<span class="op">=</span>x8<span class="op">+</span>y8<span class="op">-</span>x2<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">10</span><span class="op">:</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>      y0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>        y1<span class="op">=</span>x0<span class="op">+</span>y0<span class="op">;</span>    y2<span class="op">=</span>x1<span class="op">+</span>y1<span class="op">;</span>    y3<span class="op">=</span>x2<span class="op">+</span>y2<span class="op">;</span>    y4<span class="op">=</span>x3<span class="op">+</span>y3<span class="op">;</span></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>      y5<span class="op">=</span>x4<span class="op">+</span>y4<span class="op">;</span>    y6<span class="op">=</span>x5<span class="op">+</span>y5<span class="op">;</span>    y7<span class="op">=</span>x6<span class="op">+</span>y6<span class="op">;</span>    y8<span class="op">=</span>x7<span class="op">+</span>y7<span class="op">;</span>    y9<span class="op">=</span>x8<span class="op">+</span>y8<span class="op">;</span>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> (d3) {</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">0</span><span class="op">:</span></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>      z0<span class="op">=</span>y0<span class="op">;</span>       z1<span class="op">=</span>y1<span class="op">;</span>       z2<span class="op">=</span>y2<span class="op">;</span>       z3<span class="op">=</span>y3<span class="op">;</span>       z4<span class="op">=</span>y4<span class="op">;</span></span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>      z5<span class="op">=</span>y5<span class="op">;</span>       z6<span class="op">=</span>y6<span class="op">;</span>       z7<span class="op">=</span>y7<span class="op">;</span>       z8<span class="op">=</span>y8<span class="op">;</span>       z9<span class="op">=</span>y9<span class="op">;</span>       <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">4</span><span class="op">:</span></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>      z0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>        z1<span class="op">=</span>y0<span class="op">+</span>z0<span class="op">;</span>    z2<span class="op">=</span>y1<span class="op">+</span>z1<span class="op">;</span>    z3<span class="op">=</span>y2<span class="op">+</span>z2<span class="op">;</span>    z4<span class="op">=</span>y3<span class="op">+</span>z3<span class="op">;</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>      z5<span class="op">=</span>y4<span class="op">+</span>z4<span class="op">-</span>y0<span class="op">;</span> z6<span class="op">=</span>y5<span class="op">+</span>z5<span class="op">-</span>y1<span class="op">;</span> z7<span class="op">=</span>y6<span class="op">+</span>z6<span class="op">-</span>y2<span class="op">;</span> z8<span class="op">=</span>y7<span class="op">+</span>z7<span class="op">-</span>y3<span class="op">;</span> z9<span class="op">=</span>y8<span class="op">+</span>z8<span class="op">-</span>y4<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">6</span><span class="op">:</span></span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>      z0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>        z1<span class="op">=</span>y0<span class="op">+</span>z0<span class="op">;</span>    z2<span class="op">=</span>y1<span class="op">+</span>z1<span class="op">;</span>    z3<span class="op">=</span>y2<span class="op">+</span>z2<span class="op">;</span>    z4<span class="op">=</span>y3<span class="op">+</span>z3<span class="op">;</span></span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>      z5<span class="op">=</span>y4<span class="op">+</span>z4<span class="op">;</span>    z6<span class="op">=</span>y5<span class="op">+</span>z5<span class="op">;</span>    z7<span class="op">=</span>y6<span class="op">+</span>z6<span class="op">-</span>y0<span class="op">;</span> z8<span class="op">=</span>y7<span class="op">+</span>z7<span class="op">-</span>y1<span class="op">;</span> z9<span class="op">=</span>y8<span class="op">+</span>z8<span class="op">-</span>y2<span class="op">;</span> <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> <span class="dv">10</span><span class="op">:</span></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>      z0<span class="op">=</span><span class="dv">0</span><span class="op">;</span>        z1<span class="op">=</span>y0<span class="op">+</span>z0<span class="op">;</span>    z2<span class="op">=</span>y1<span class="op">+</span>z1<span class="op">;</span>    z3<span class="op">=</span>y2<span class="op">+</span>z2<span class="op">;</span>    z4<span class="op">=</span>y3<span class="op">+</span>z3<span class="op">;</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>      z5<span class="op">=</span>y4<span class="op">+</span>z4<span class="op">;</span>    z6<span class="op">=</span>y5<span class="op">+</span>z5<span class="op">;</span>    z7<span class="op">=</span>y6<span class="op">+</span>z6<span class="op">;</span>    z8<span class="op">=</span>y7<span class="op">+</span>z7<span class="op">;</span>    z9<span class="op">=</span>y8<span class="op">+</span>z8<span class="op">;</span>    <span class="cf">break</span><span class="op">;</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> (z0<span class="op">+</span>z1<span class="op">+</span>z2<span class="op">+</span>z3<span class="op">+</span>z4<span class="op">+</span>z5<span class="op">+</span>z6<span class="op">+</span>z7<span class="op">+</span>z8<span class="op">+</span>z9)<span class="op">/</span>m<span class="op">;</span></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And here’s the function that computes the same result as <code>pSetsFail()</code> above,
again with slightly different parameters:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode javascript"><code class="sourceCode javascript"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">pSetsFail</span>(ds) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p0 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">0</span>]<span class="op">,</span> ds[<span class="dv">1</span>]<span class="op">,</span> ds[<span class="dv">2</span>]<span class="op">,</span> ds[<span class="dv">3</span>])<span class="op">;</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p1 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">4</span>]<span class="op">,</span> ds[<span class="dv">5</span>]<span class="op">,</span> ds[<span class="dv">6</span>]<span class="op">,</span> ds[<span class="dv">7</span>])<span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p2 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">8</span>]<span class="op">,</span> ds[<span class="dv">9</span>]<span class="op">,</span> ds[<span class="dv">10</span>]<span class="op">,</span> ds[<span class="dv">11</span>])<span class="op">;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p3 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">12</span>]<span class="op">,</span> ds[<span class="dv">13</span>]<span class="op">,</span> ds[<span class="dv">14</span>]<span class="op">,</span> ds[<span class="dv">15</span>])<span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p4 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">16</span>]<span class="op">,</span> ds[<span class="dv">17</span>]<span class="op">,</span> ds[<span class="dv">18</span>]<span class="op">,</span> ds[<span class="dv">19</span>])<span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p5 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">20</span>]<span class="op">,</span> ds[<span class="dv">21</span>]<span class="op">,</span> ds[<span class="dv">22</span>]<span class="op">,</span> ds[<span class="dv">23</span>])<span class="op">;</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p6 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">24</span>]<span class="op">,</span> ds[<span class="dv">25</span>]<span class="op">,</span> ds[<span class="dv">26</span>]<span class="op">,</span> ds[<span class="dv">27</span>])<span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p7 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">28</span>]<span class="op">,</span> ds[<span class="dv">29</span>]<span class="op">,</span> ds[<span class="dv">30</span>]<span class="op">,</span> ds[<span class="dv">31</span>])<span class="op">;</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p8 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">32</span>]<span class="op">,</span> ds[<span class="dv">33</span>]<span class="op">,</span> ds[<span class="dv">34</span>]<span class="op">,</span> ds[<span class="dv">35</span>])<span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> p9 <span class="op">=</span> <span class="fu">pSetFail</span>(ds[<span class="dv">36</span>]<span class="op">,</span> ds[<span class="dv">37</span>]<span class="op">,</span> ds[<span class="dv">38</span>]<span class="op">,</span> ds[<span class="dv">39</span>])<span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> a1 <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> p0<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> b0 <span class="op">=</span> p1 <span class="op">*</span> p0<span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> b1 <span class="op">=</span> p1 <span class="op">*</span> a1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p1) <span class="op">*</span> p0<span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> b2 <span class="op">=</span> (<span class="dv">1</span> <span class="op">-</span> p1) <span class="op">*</span> a1<span class="op">;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> c0 <span class="op">=</span> p2 <span class="op">*</span> b0<span class="op">;</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> c1 <span class="op">=</span> p2 <span class="op">*</span> b1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p2) <span class="op">*</span> b0<span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> c2 <span class="op">=</span> p2 <span class="op">*</span> b2 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p2) <span class="op">*</span> b1<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> d0 <span class="op">=</span> p3 <span class="op">*</span> c0<span class="op">;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> d1 <span class="op">=</span> p3 <span class="op">*</span> c1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p3) <span class="op">*</span> c0<span class="op">;</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> d2 <span class="op">=</span> p3 <span class="op">*</span> c2 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p3) <span class="op">*</span> c1<span class="op">;</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> e0 <span class="op">=</span> p4 <span class="op">*</span> d0<span class="op">;</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> e1 <span class="op">=</span> p4 <span class="op">*</span> d1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p4) <span class="op">*</span> d0<span class="op">;</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> e2 <span class="op">=</span> p4 <span class="op">*</span> d2 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p4) <span class="op">*</span> d1<span class="op">;</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> f0 <span class="op">=</span> p5 <span class="op">*</span> e0<span class="op">;</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> f1 <span class="op">=</span> p5 <span class="op">*</span> e1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p5) <span class="op">*</span> e0<span class="op">;</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> f2 <span class="op">=</span> p5 <span class="op">*</span> e2 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p5) <span class="op">*</span> e1<span class="op">;</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g0 <span class="op">=</span> p6 <span class="op">*</span> f0<span class="op">;</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g1 <span class="op">=</span> p6 <span class="op">*</span> f1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p6) <span class="op">*</span> f0<span class="op">;</span></span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> g2 <span class="op">=</span> p6 <span class="op">*</span> f2 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p6) <span class="op">*</span> f1<span class="op">;</span></span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> h0 <span class="op">=</span> p7 <span class="op">*</span> g0<span class="op">;</span></span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> h1 <span class="op">=</span> p7 <span class="op">*</span> g1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p7) <span class="op">*</span> g0<span class="op">;</span></span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> h2 <span class="op">=</span> p7 <span class="op">*</span> g2 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p7) <span class="op">*</span> g1<span class="op">;</span></span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> i0 <span class="op">=</span> p8 <span class="op">*</span> h0<span class="op">;</span></span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> i1 <span class="op">=</span> p8 <span class="op">*</span> h1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p8) <span class="op">*</span> h0<span class="op">;</span></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> i2 <span class="op">=</span> p8 <span class="op">*</span> h2 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p8) <span class="op">*</span> h1<span class="op">;</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> j0 <span class="op">=</span> p9 <span class="op">*</span> i0<span class="op">;</span></span>
<span id="cb5-48"><a href="#cb5-48" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> j1 <span class="op">=</span> p9 <span class="op">*</span> i1 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p9) <span class="op">*</span> i0<span class="op">;</span></span>
<span id="cb5-49"><a href="#cb5-49" aria-hidden="true" tabindex="-1"></a>  <span class="kw">const</span> j2 <span class="op">=</span> p9 <span class="op">*</span> i2 <span class="op">+</span> (<span class="dv">1</span> <span class="op">-</span> p9) <span class="op">*</span> i1<span class="op">;</span></span>
<span id="cb5-50"><a href="#cb5-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-51"><a href="#cb5-51" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> j0 <span class="op">+</span> j1 <span class="op">+</span> j2<span class="op">;</span></span>
<span id="cb5-52"><a href="#cb5-52" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>When running this on the worst case input with the same benchmarking strategy as
before, I get times of <strong>400 nanoseconds</strong>.</p>
<p>Why is it so much faster? Well, I can’t be 100% sure without digging deeper, but
my guess is this is very JIT-friendly code, and that the CPU code it generates
is very cache-friendly. <code>pSetFail</code> is also all integer sums and products until
the return statement, which probably helps a bit. Maybe with a bit more digging
it could be made even faster. But I think 400ns is pretty fast. That’s a 3000x
improvement from where we started. Not bad!</p>
<p>By the way, if you look very closely at <code>pSetFail</code>, you might notice that it
looks a lot like the ultimate brute force solution: counting up the possible
ways to get different sums.</p>
<h2 id="the-future">The future?</h2>
<p>We’re still using a naive convolution algorithm, one essentially based directly
on the definition. For small sequences this works well enough, but for larger
sequences this becomes prohibitive. This type of convolution comes up in signal
processing a lot, where you might want to compute the convolution of two
sequences that have tens of thousands of elements. In those scenarios you can
take advantage of the convolution theorem, which lets you multiply the Fourier
transforms of the inputs point-wise and do an inverse Fourier transform to get
the same result. This is also the basis of some fast integer multiplication
algorithms.</p>
<p>Are our inputs too small to benefit from this knowledge? Probably. But I can’t
help but be a little curious. If I ever decide to give it a shot, I’ll be sure
to write about it.</p>
    </section>
</article>

<footer>
    <a href="../">&larr; Index</a>
    <div class="rights">
        This work &copy; 2024 by Alex Iadicicco is licensed under
        <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
            CC BY-NC-SA 4.0
        </a>
    </div>
</footer>

        </main>
    </body>
</html>
